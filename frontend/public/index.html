<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduTech</title>
  <link rel="stylesheet" href="index.css" />
  <script src="https://kit.fontawesome.com/1dc5e8d3e7.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="content">

    <h1>EXERC√çCIOS</h1>

    <input type="text" id="campo-pesquisa" placeholder="Digite o t√≠tulo do exerc√≠cio" />
    <button id="btnAbrirModalNovoExercicio">Novo Exerc√≠cio</button>
    <button onclick="pesquisarExercicio()">Pesquisar üîç</button>

    <ul id="lista-exercicios"></ul>

    <div id="sidebar">
      <button class="close-btn" onclick="fecharSidebar()">√ó</button>
      <div id="detalhes-exercicio"></div>
    </div>

  </div>

  <div id="modalNovoExercicio" class="modal">
    <div class="modal-content">
        <span class="close-button" id="btnCloseModalNovoExercicio">&times;</span>

        <div class="exercicio"> <h2>Novo Exerc√≠cio</h2>
            <div class="container-form-mapas"> <div class="box-form-mapas form">
                <form id="formExercicioModal"> <h3>T√≠tulo</h3>
                    <input type="text" id="tituloModal" placeholder="Digite um t√≠tulo" class="texto" required />

                    <h3>Descri√ß√£o</h3>
                    <textarea
                        id="descricaoModal"
                        rows="5"
                        cols="50"
                        placeholder="Descreva o exerc√≠cio"
                        class="texto"
                        style="resize: none;"
                        required
                    ></textarea>

                    <h3>
                        SELECIONE O MAPA
                        <button type="button" class="mapa" onclick="mostrarImagemModal()" id="selMapaModal">
                            Selecionar <i class="fa-solid fa-map icon"></i>
                        </button>
                    </h3>
                    <div id="imagemMapaModal" style="display: none; margin-top: 10px;">
                        <img src="./images/mapa.jpeg" alt="Mapa Selecionado" style="max-width: 100%; border: 1px solid #ccc; margin-bottom: 10px;" />
                        <button type="button" onclick="salvarMapaModal()" class="btn-salvar-mapa">Salvar Mapa</button>
                    </div>

                    <h3>N√≠vel de Dificuldade</h3>
                    <select id="nivelDificuldadeModal" class="texto" required>
                        <option value="" disabled selected>Selecione o n√≠vel</option>
                        <option value="F√°cil">F√°cil</option>
                        <option value="M√©dio">M√©dio</option>
                        <option value="Avan√ßado">Avan√ßado</option>
                    </select>

                    <h3>Alternativas</h3>
                    <p style="font-size: 0.8em; color: #555;">(Preencha as alternativas abaixo. Para marcar a correta, faremos um ajuste futuro)</p>
                    <input type="text" id="alt1Modal" placeholder="Alternativa 1" class="texto" required />
                    <input type="text" id="alt2Modal" placeholder="Alternativa 2" class="texto" required />
                    <input type="text" id="alt3Modal" placeholder="Alternativa 3" class="texto" required />
                    <input type="text" id="alt4Modal" placeholder="Alternativa 4" class="texto" required />

                    <br /><br />

                    <button type="button" class="voltar btns" onclick="fecharModalNovoExercicio()">Cancelar</button>
                    <button type="submit" class="salvar btns">Salvar Exerc√≠cio</button>
                </form>
            </div>
            </div>
        </div>
        </div>
</div>

  <script>
    // --- SEU SCRIPT EXISTENTE PARA LISTA E SIDEBAR (Mantido) ---
    const lista = document.getElementById('lista-exercicios');
    const sidebar = document.getElementById('sidebar');
    const detalhesDiv = document.getElementById('detalhes-exercicio');

    function carregarExercicios() {
      fetch('http://localhost:3000/exercicios')
        .then(res => res.json())
        .then(data => exibirLista(data))
        .catch(err => console.error('Erro ao buscar exerc√≠cios:', err));
    }

    function exibirLista(data) {
      lista.innerHTML = '';
      data.forEach(exercicio => {
        const item = document.createElement('li');
        item.innerHTML = `
          <button onclick="verExercicio(${exercicio.id})">${exercicio.titulo}</button>
          <div class="botoes">
            <button onclick="editarExercicio(${exercicio.id})">üñäÔ∏è</button>
            <button onclick="excluirExercicio(${exercicio.id})">üóëÔ∏è</button>
          </div>
        `;
        lista.appendChild(item);
      });
    }

    function pesquisarExercicio() {
      const termo = document.getElementById('campo-pesquisa').value.toLowerCase();
      fetch('http://localhost:3000/exercicios')
        .then(res => res.json())
        .then(data => {
          const filtrados = data.filter(ex => ex.titulo.toLowerCase().includes(termo));
          exibirLista(filtrados);
        })
        .catch(err => console.error('Erro ao pesquisar:', err));
    }

    function excluirExercicio(id) {
      fetch(`http://localhost:3000/exercicios/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then((resposta) => { // Adicionado par√¢metro para a resposta
          alert(resposta.mensagem || 'Exerc√≠cio exclu√≠do!'); // Usa a mensagem do backend
          carregarExercicios();
        })
        .catch(err => console.error('Erro ao excluir:', err));
    }

    function verExercicio(id) {
      fetch(`http://localhost:3000/exercicios/${id}`)
        .then(res => res.json())
        .then(exercicio => {
          // Verifica se o exerc√≠cio e as alternativas existem antes de tentar acess√°-los
          const alternativasTexto = exercicio.alternativas && Array.isArray(exercicio.alternativas) 
                                    ? exercicio.alternativas.join(', ') 
                                    : 'Nenhuma alternativa dispon√≠vel';
          detalhesDiv.innerHTML = `
            <h2>${exercicio.titulo || 'T√≠tulo n√£o dispon√≠vel'}</h2>
            <p><strong>Descri√ß√£o:</strong> ${exercicio.descricao || 'Descri√ß√£o n√£o dispon√≠vel'}</p>
             <img src="./images/mapa.jpeg"> <p><strong>N√≠vel:</strong> ${exercicio.nivelDificuldade || 'N√≠vel n√£o dispon√≠vel'}</p>
              <p><strong>Alternativas:</strong> ${alternativasTexto}</p>
          `;
          abrirSidebar();
        })
        .catch(err => console.error('Erro ao exibir exerc√≠cio:', err));
    }

    function abrirSidebar() {
      sidebar.classList.add('open');
    }

    function fecharSidebar() {
      sidebar.classList.remove('open');
    }

    // ADICIONADO: Placeholder para a fun√ß√£o editarExercicio
    function editarExercicio(id) {
        console.log('Fun√ß√£o editarExercicio chamada com ID:', id);
        alert('Funcionalidade "Editar Exerc√≠cio" (ID: ' + id + ') ainda a ser implementada.');
        // Exemplo: window.location.href = `alterarExercicio.html?id=${id}`;
    }

    carregarExercicios(); // Carrega os exerc√≠cios ao iniciar a p√°gina

    // --- NOVO C√ìDIGO PARA A L√ìGICA DO MODAL (Integrado aqui) ---
    const modalNovo = document.getElementById('modalNovoExercicio');
    const btnAbrirModal = document.getElementById('btnAbrirModalNovoExercicio');
    const btnFecharModal = document.getElementById('btnCloseModalNovoExercicio'); // Bot√£o 'X' do modal
    const formExercicioModal = document.getElementById('formExercicioModal'); // Formul√°rio dentro do modal

    let mapaSelecionadoModal = "Nenhum"; // Vari√°vel para o mapa selecionado no modal

    function mostrarImagemModal() {
        const imgMapaDiv = document.getElementById('imagemMapaModal');
        if (imgMapaDiv) imgMapaDiv.style.display = 'block';
    }

    function salvarMapaModal() {
        mapaSelecionadoModal = "Mapa A"; // Voc√™ pode tornar isso din√¢mico se tiver m√∫ltiplos mapas no modal
        alert("Mapa salvo no modal: " + mapaSelecionadoModal);
        const imgMapaDiv = document.getElementById('imagemMapaModal');
        if (imgMapaDiv) imgMapaDiv.style.display = 'none';
    }

    function abrirModalNovoExercicio() {
        console.log('Tentando abrir modal...');
        if(modalNovo) {
            modalNovo.style.display = 'block';
            console.log('Modal display set to block');
        } else {
            console.error('Elemento modalNovo n√£o encontrado!');
        }
    }

    function fecharModalNovoExercicio() {
        if(modalNovo) modalNovo.style.display = 'none';
        if(formExercicioModal) formExercicioModal.reset(); // Limpa o formul√°rio ao fechar
        mapaSelecionadoModal = "Nenhum"; // Reseta o mapa selecionado
        const imgMapaDiv = document.getElementById('imagemMapaModal');
        if (imgMapaDiv) imgMapaDiv.style.display = 'none'; // Esconde a sele√ß√£o de imagem do mapa
    }

    // Event Listeners para o modal
    if(btnAbrirModal) {
        console.log('Adicionando listener para btnAbrirModal');
        btnAbrirModal.addEventListener('click', abrirModalNovoExercicio);
    } else {
        console.error('Bot√£o btnAbrirModalNovoExercicio n√£o encontrado!');
    }

    if(btnFecharModal) {
        btnFecharModal.addEventListener('click', fecharModalNovoExercicio);
    } else {
        console.error('Bot√£o btnCloseModalNovoExercicio n√£o encontrado!');
    }

    // Fechar o modal se clicar fora da √°rea do conte√∫do
    window.addEventListener('click', function(event) {
        if (event.target == modalNovo) {
            fecharModalNovoExercicio();
        }
    });

    // L√≥gica de submiss√£o do formul√°rio DENTRO DO MODAL
    if(formExercicioModal) {
        formExercicioModal.addEventListener('submit', async function(e) {
            e.preventDefault();

            const titulo = document.getElementById('tituloModal').value.trim();
            const descricao = document.getElementById('descricaoModal').value.trim();
            const nivelDificuldade = document.getElementById('nivelDificuldadeModal').value;
            // Coleta as alternativas como array de strings
            const alternativas = [
                document.getElementById('alt1Modal').value.trim(),
                document.getElementById('alt2Modal').value.trim(),
                document.getElementById('alt3Modal').value.trim(),
                document.getElementById('alt4Modal').value.trim()
            ].filter(alt => alt !== ""); // Garante que alternativas vazias n√£o sejam enviadas (opcional)


            if (!titulo || !descricao || !nivelDificuldade || alternativas.length === 0) {
                alert("Por favor, preencha todos os campos obrigat√≥rios do modal (T√≠tulo, Descri√ß√£o, N√≠vel e pelo menos uma Alternativa).");
                return;
            }
            
            // Nota: Seu backend atualmente aceita 'alternativas' como um array de strings.
            // Se precisar enviar a informa√ß√£o de "correta", o formato seria um array de objetos:
            // [{texto: "...", correta: true/false}, ...]
            // Voc√™ precisaria de inputs (ex: radio buttons) no formul√°rio para marcar a correta.

            const novoExercicio = {
                titulo,
                descricao,
                mapaSelecionado: mapaSelecionadoModal,
                nivelDificuldade,
                alternativas
            };

            console.log("Enviando exerc√≠cio:", novoExercicio);

            try {
                const response = await fetch('http://localhost:3000/exercicios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novoExercicio)
                });

                const respostaBackend = await response.json(); // Sempre tente ler a resposta

                if (response.ok) {
                    alert(respostaBackend.mensagem || "Exerc√≠cio adicionado com sucesso pelo modal!");
                    fecharModalNovoExercicio();
                    carregarExercicios(); // Recarrega a lista na p√°gina principal
                } else {
                    alert("Erro ao adicionar (modal): " + (respostaBackend.mensagem || "Erro desconhecido do servidor."));
                }
            } catch (err) {
                alert("Erro de rede ou servidor (modal). Verifique o console.");
                console.error("Erro no fetch POST:",err);
            }
        });
    } else {
        console.error('Formul√°rio formExercicioModal n√£o encontrado!');
    }
  </script>
</body>
</html>